apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: rabbitmq-alerts
  namespace: rabbitmq
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: monitoring
spec:
  groups:
  - name: rabbitmq
    interval: 30s
    rules:
    
    - alert: RabbitMQDown
      expr: up{job="rabbitmq"} == 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "RabbitMQ instance is down"
        description: "RabbitMQ instance {{ $labels.instance }} has been down for more than 5 minutes."
        runbook_url: "https://github.com/rabbitmq/rabbitmq-server/tree/main/deps/rabbitmq_prometheus"
    
    - alert: RabbitMQMemoryHigh
      expr: rabbitmq_process_resident_memory_bytes / rabbitmq_process_max_tcp_sockets * 100 > 80
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "RabbitMQ memory usage is high"
        description: "RabbitMQ instance {{ $labels.instance }} memory usage is above 80%."
    
    - alert: RabbitMQDiskSpaceLow
      expr: rabbitmq_disk_space_available_bytes / 1024 / 1024 / 1024 < 2
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "RabbitMQ disk space is low"
        description: "RabbitMQ instance {{ $labels.instance }} has less than 2GB disk space available."
    
    - alert: RabbitMQFileDescriptorsHigh
      expr: rabbitmq_process_open_fds / rabbitmq_process_max_fds * 100 > 80
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "RabbitMQ file descriptor usage is high"
        description: "RabbitMQ instance {{ $labels.instance }} file descriptor usage is above 80%."
    
    - alert: RabbitMQSocketDescriptorsHigh
      expr: rabbitmq_process_open_tcp_sockets / rabbitmq_process_max_tcp_sockets * 100 > 80
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "RabbitMQ socket descriptor usage is high"
        description: "RabbitMQ instance {{ $labels.instance }} socket descriptor usage is above 80%."
    
    - alert: RabbitMQClusterPartition
      expr: rabbitmq_partitions{job="rabbitmq"} > 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "RabbitMQ cluster partition detected"
        description: "RabbitMQ cluster has {{ $value }} partitions."
    
    - alert: RabbitMQQueueMessagesHigh
      expr: rabbitmq_queue_messages{job="rabbitmq"} > 1000000
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "RabbitMQ queue has too many messages"
        description: "Queue {{ $labels.queue }} on {{ $labels.instance }} has {{ $value }} messages."
    
    - alert: RabbitMQConsumerUtilisationLow
      expr: rabbitmq_queue_consumer_utilisation{job="rabbitmq"} < 0.5 and rabbitmq_queue_consumer_utilisation{job="rabbitmq"} > 0
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "RabbitMQ queue consumer utilisation is low"
        description: "Queue {{ $labels.queue }} on {{ $labels.instance }} has consumer utilisation below 50%."
    
    - alert: RabbitMQConnectionChurnHigh
      expr: rate(rabbitmq_connections_opened_total[5m]) > 100 or rate(rabbitmq_connections_closed_total[5m]) > 100
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "RabbitMQ connection churn is high"
        description: "RabbitMQ instance {{ $labels.instance }} has high connection churn rate."
    
    - alert: RabbitMQChannelChurnHigh
      expr: rate(rabbitmq_channels_opened_total[5m]) > 100 or rate(rabbitmq_channels_closed_total[5m]) > 100
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "RabbitMQ channel churn is high"
        description: "RabbitMQ instance {{ $labels.instance }} has high channel churn rate."
    
    - alert: RabbitMQQueueNotConsuming
      expr: rabbitmq_queue_consumers{job="rabbitmq"} == 0 and rabbitmq_queue_messages{job="rabbitmq"} > 0
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "RabbitMQ queue has no consumers"
        description: "Queue {{ $labels.queue }} on {{ $labels.instance }} has messages but no consumers."
    
    - alert: RabbitMQNodeNotRunning
      expr: rabbitmq_running{job="rabbitmq"} == 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "RabbitMQ node is not running"
        description: "RabbitMQ node {{ $labels.instance }} is not running."
    
    - alert: RabbitMQMnesiaTransactionsHigh
      expr: rate(rabbitmq_mnesia_transactions_committed_total[5m]) > 1000
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "RabbitMQ Mnesia transaction rate is high"
        description: "RabbitMQ instance {{ $labels.instance }} has high Mnesia transaction rate."