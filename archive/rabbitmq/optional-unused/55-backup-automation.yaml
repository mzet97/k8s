apiVersion: batch/v1
kind: CronJob
metadata:
  name: rabbitmq-backup-cronjob
  namespace: rabbitmq
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: backup-cronjob
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: rabbitmq
            app.kubernetes.io/component: backup-job
        spec:
          restartPolicy: OnFailure
          serviceAccountName: rabbitmq-backup
          containers:
          - name: rabbitmq-backup
            image: rabbitmq:3.12-management-alpine
            command:
            - /bin/bash
            - -c
            - |
              set -e
              
              # Configuration
              RABBITMQ_HOST="rabbitmq.rabbitmq.svc.cluster.local"
              RABBITMQ_PORT="15672"
              RABBITMQ_USER="admin"
              RABBITMQ_PASS="${RABBITMQ_PASSWORD}"
              BACKUP_DIR="/backups"
              DATE=$(date +%Y%m%d_%H%M%S)
              
              echo "Starting RabbitMQ backup at $(date)"
              
              # Create backup directory
              mkdir -p "${BACKUP_DIR}/${DATE}"
              
              # Export definitions
              echo "Exporting RabbitMQ definitions..."
              curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" \
                "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/definitions" \
                -o "${BACKUP_DIR}/${DATE}/definitions.json"
              
              # Export user definitions
              echo "Exporting users..."
              curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" \
                "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/users" \
                -o "${BACKUP_DIR}/${DATE}/users.json"
              
              # Export vhosts
              echo "Exporting vhosts..."
              curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" \
                "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/vhosts" \
                -o "${BACKUP_DIR}/${DATE}/vhosts.json"
              
              # Export queues
              echo "Exporting queues..."
              curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" \
                "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/queues" \
                -o "${BACKUP_DIR}/${DATE}/queues.json"
              
              # Export exchanges
              echo "Exporting exchanges..."
              curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" \
                "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/exchanges" \
                -o "${BACKUP_DIR}/${DATE}/exchanges.json"
              
              # Export bindings
              echo "Exporting bindings..."
              curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" \
                "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/bindings" \
                -o "${BACKUP_DIR}/${DATE}/bindings.json"
              
              # Export policies
              echo "Exporting policies..."
              curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" \
                "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/policies" \
                -o "${BACKUP_DIR}/${DATE}/policies.json"
              
              # Export parameters
              echo "Exporting parameters..."
              curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" \
                "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/parameters" \
                -o "${BACKUP_DIR}/${DATE}/parameters.json"
              
              # Create metadata file
              echo "Creating backup metadata..."
              cat > "${BACKUP_DIR}/${DATE}/metadata.json" << EOF
              {
                "backup_date": "$(date -Iseconds)",
                "rabbitmq_version": "$(curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/overview" | jq -r '.rabbitmq_version // "unknown"')",
                "cluster_name": "$(curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/overview" | jq -r '.cluster_name // "unknown"')",
                "node_count": "$(curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/nodes" | jq length)",
                "queue_count": "$(curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/queues" | jq length)",
                "connection_count": "$(curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/connections" | jq length)"
              }
              EOF
              
              # Create archive
              echo "Creating backup archive..."
              cd "${BACKUP_DIR}"
              tar -czf "rabbitmq-backup-${DATE}.tar.gz" "${DATE}/"
              
              # Verify backup
              echo "Verifying backup integrity..."
              if tar -tzf "rabbitmq-backup-${DATE}.tar.gz" > /dev/null; then
                echo "Backup archive verified successfully"
              else
                echo "ERROR: Backup archive verification failed"
                exit 1
              fi
              
              # Clean up old directory (keep archive)
              rm -rf "${BACKUP_DIR}/${DATE}"
              
              # Remove old backups (keep last 7 days)
              find "${BACKUP_DIR}" -name "rabbitmq-backup-*.tar.gz" -mtime +7 -delete
              
              echo "Backup completed successfully at $(date)"
              echo "Backup file: rabbitmq-backup-${DATE}.tar.gz"
              
            env:
            - name: RABBITMQ_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-basic-auth
                  key: password
            volumeMounts:
            - name: backup-storage
              mountPath: /backups
            - name: backup-scripts
              mountPath: /scripts
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "200m"
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: rabbitmq-backup-pvc
          - name: backup-scripts
            configMap:
              name: rabbitmq-backup-scripts
              defaultMode: 0755
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: rabbitmq-backup-pvc
  namespace: rabbitmq
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: backup-storage
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: rabbitmq-standard-storage
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-backup-scripts
  namespace: rabbitmq
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: backup-scripts
data:
  restore.sh: |
    #!/bin/bash
    set -e
    
    # RabbitMQ Restore Script
    # Usage: ./restore.sh <backup-file> [target-rabbitmq-host]
    
    BACKUP_FILE="$1"
    TARGET_HOST="${2:-rabbitmq.rabbitmq.svc.cluster.local}"
    TARGET_PORT="15672"
    TARGET_USER="admin"
    TARGET_PASS="${RABBITMQ_PASSWORD}"
    
    if [ -z "$BACKUP_FILE" ]; then
      echo "Usage: $0 <backup-file> [target-rabbitmq-host]"
      exit 1
    fi
    
    if [ ! -f "$BACKUP_FILE" ]; then
      echo "Backup file not found: $BACKUP_FILE"
      exit 1
    fi
    
    echo "Starting restore from $BACKUP_FILE to $TARGET_HOST"
    
    # Extract backup
    TEMP_DIR=$(mktemp -d)
    tar -xzf "$BACKUP_FILE" -C "$TEMP_DIR"
    
    # Find extracted directory
    BACKUP_DIR=$(find "$TEMP_DIR" -type d -name "20*" | head -1)
    
    if [ -z "$BACKUP_DIR" ]; then
      echo "Could not find backup directory in archive"
      exit 1
    fi
    
    # Restore definitions
    echo "Restoring definitions..."
    curl -s -u "${TARGET_USER}:${TARGET_PASS}" \
      -X POST "http://${TARGET_HOST}:${TARGET_PORT}/api/definitions" \
      -H "Content-Type: application/json" \
      -d @"${BACKUP_DIR}/definitions.json"
    
    echo "Restore completed successfully"
    
    # Cleanup
    rm -rf "$TEMP_DIR"
  
  health-check.sh: |
    #!/bin/bash
    set -e
    
    # RabbitMQ Health Check Script
    RABBITMQ_HOST="${1:-rabbitmq.rabbitmq.svc.cluster.local}"
    RABBITMQ_PORT="15672"
    RABBITMQ_USER="admin"
    RABBITMQ_PASS="${RABBITMQ_PASSWORD}"
    
    echo "Checking RabbitMQ health at ${RABBITMQ_HOST}:${RABBITMQ_PORT}"
    
    # Check if RabbitMQ is responding
    if ! curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" \
      "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/overview" > /dev/null; then
      echo "ERROR: RabbitMQ is not responding"
      exit 1
    fi
    
    # Get cluster status
    CLUSTER_STATUS=$(curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" \
      "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/overview" | jq -r '.object_totals // empty')
    
    if [ -z "$CLUSTER_STATUS" ]; then
      echo "WARNING: Could not get cluster status"
    else
      echo "Cluster status: $CLUSTER_STATUS"
    fi
    
    # Check for alarms
    ALARMS=$(curl -s -u "${RABBITMQ_USER}:${RABBITMQ_PASS}" \
      "http://${RABBITMQ_HOST}:${RABBITMQ_PORT}/api/alarms" | jq length)
    
    if [ "$ALARMS" -gt 0 ]; then
      echo "WARNING: $ALARMS alarms active"
    else
      echo "No alarms active"
    fi
    
    echo "Health check completed successfully"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rabbitmq-backup
  namespace: rabbitmq
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: backup-serviceaccount
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: rabbitmq-backup
  namespace: rabbitmq
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: backup-role
rules:
- apiGroups: [""]
  resources: ["configmaps", "secrets", "persistentvolumeclaims"]
  verbs: ["get", "list"]
- apiGroups: ["apps"]
  resources: ["statefulsets", "deployments"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "exec"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: rabbitmq-backup
  namespace: rabbitmq
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: backup-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rabbitmq-backup
subjects:
- kind: ServiceAccount
  name: rabbitmq-backup
  namespace: rabbitmq