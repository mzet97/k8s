# Como Acessar o Monitoring Stack

## ‚úÖ Monitoring Stack Instalado com Sucesso

O **Monitoring Stack** (Prometheus + Grafana + Loki) est√° dispon√≠vel em:

**Grafana**: https://grafana.home.arpa/
**Prometheus**: https://prometheus.home.arpa/
**Loki**: Interno (loki.monitoring.svc.cluster.local:3100)

## üîê Credenciais de Acesso

### Grafana
- **Usu√°rio**: `admin`
- **Senha**: `Admin@123`

### Prometheus
- Sem autentica√ß√£o (acesso direto)

## üìã Informa√ß√µes da Instala√ß√£o

| Componente | URL/Endpoint | Porta |
|------------|--------------|-------|
| **Grafana** | https://grafana.home.arpa/ | 3000 |
| **Prometheus** | https://prometheus.home.arpa/ | 9090 |
| **Loki** | loki.monitoring.svc.cluster.local | 3100 |
| **Node Exporter** | node-exporter.monitoring.svc.cluster.local | 9100 |
| **Kube State Metrics** | kube-state-metrics.monitoring.svc.cluster.local | 8080 |

### Detalhes T√©cnicos

| Item | Valor |
|------|-------|
| **Namespace** | monitoring |
| **Ingress IP** | 192.168.1.51 |
| **TLS** | ‚úÖ Sim (cert-manager local-ca) |
| **Persist√™ncia Prometheus** | 20Gi |
| **Persist√™ncia Grafana** | 10Gi |
| **Persist√™ncia Loki** | 10Gi |
| **StorageClass** | local-path (K3s) |

## üåê Configura√ß√£o DNS

### Se j√° configurou no roteador:
‚úÖ Voc√™ j√° apontou `*.home.arpa` para `192.168.1.51` no roteador
‚úÖ Pode acessar diretamente:
   - https://grafana.home.arpa/
   - https://prometheus.home.arpa/

### Se ainda n√£o configurou localmente:

**Linux/Mac**:
```bash
echo "192.168.1.51 grafana.home.arpa" | sudo tee -a /etc/hosts
echo "192.168.1.51 prometheus.home.arpa" | sudo tee -a /etc/hosts
```

**Windows** (como Administrador):
```powershell
Add-Content C:\Windows\System32\drivers\etc\hosts "192.168.1.51 grafana.home.arpa"
Add-Content C:\Windows\System32\drivers\etc\hosts "192.168.1.51 prometheus.home.arpa"
```

## üß™ Testar Acesso

### M√©todo 1: Browser (Grafana)
1. Abra o navegador
2. Acesse: https://grafana.home.arpa/
3. Aceite o certificado autoassinado (√© esperado)
4. Login: `admin` / `Admin@123`

### M√©todo 2: Browser (Prometheus)
1. Abra o navegador
2. Acesse: https://prometheus.home.arpa/
3. Aceite o certificado autoassinado
4. Navegue sem login

### M√©todo 3: curl (API)
```bash
# Testar Grafana API
curl -k https://grafana.home.arpa/api/health

# Testar Prometheus API
curl -k https://prometheus.home.arpa/api/v1/status/config

# Testar Loki (dentro do cluster)
kubectl exec -n monitoring prometheus-0 -- curl http://loki.monitoring.svc.cluster.local:3100/ready
```

## üìä Grafana - Dashboard e Visualiza√ß√£o

### üéØ O que voc√™ pode fazer no Grafana

‚úÖ **Visualizar dashboards** interativos
‚úÖ **Criar dashboards** personalizados
‚úÖ **Consultar m√©tricas** do Prometheus
‚úÖ **Consultar logs** do Loki
‚úÖ **Criar alertas** baseados em m√©tricas
‚úÖ **Gerenciar usu√°rios** e permiss√µes
‚úÖ **Importar dashboards** da comunidade
‚úÖ **Criar pain√©is** com m√∫ltiplas visualiza√ß√µes

### üìà Dashboards Recomendados para Importar

Acesse: Grafana ‚Üí Dashboards ‚Üí Import

**Kubernetes**:
- ID: 315 (Kubernetes cluster monitoring)
- ID: 6417 (Kubernetes cluster monitoring (Prometheus))
- ID: 7249 (Kubernetes Cluster)

**Node Exporter**:
- ID: 1860 (Node Exporter Full)
- ID: 11074 (Node Exporter for Prometheus)

**Redis** (quando instalado):
- ID: 11835 (Redis Dashboard for Prometheus)

**RabbitMQ** (quando instalado):
- ID: 10991 (RabbitMQ Overview)

**MinIO** (quando instalado):
- ID: 13502 (MinIO Dashboard)

### Como Importar Dashboard

1. No Grafana, clique no √≠cone **+** no menu lateral
2. Selecione **Import**
3. Digite o **Dashboard ID** (ex: 1860)
4. Clique em **Load**
5. Selecione **Prometheus** como Data Source
6. Clique em **Import**

### Criar Dashboard Personalizado

1. Clique no √≠cone **+** ‚Üí **Dashboard**
2. Clique em **Add visualization**
3. Selecione **Prometheus** como Data Source
4. Digite uma query PromQL
5. Configure visualiza√ß√£o (gr√°fico, gauge, stat, etc)
6. Clique em **Save**

### Exemplo de Queries PromQL

```promql
# CPU usage por node
100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# Mem√≥ria dispon√≠vel
node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100

# Pods rodando por namespace
count(kube_pod_info) by (namespace)

# Requests HTTP por segundo
rate(http_requests_total[5m])

# Redis comandos por segundo
rate(redis_commands_processed_total[5m])

# RabbitMQ mensagens enfileiradas
rabbitmq_queue_messages
```

## üîç Prometheus - M√©tricas e Queries

### O que voc√™ pode fazer no Prometheus

‚úÖ **Consultar m√©tricas** com PromQL
‚úÖ **Visualizar gr√°ficos** de s√©ries temporais
‚úÖ **Ver targets** (endpoints sendo monitorados)
‚úÖ **Gerenciar alertas**
‚úÖ **Ver configura√ß√£o** do Prometheus

### Interface do Prometheus

**Graph**: Executar queries e visualizar gr√°ficos
**Alerts**: Ver status de alertas configurados
**Status ‚Üí Targets**: Ver todos os endpoints monitorados
**Status ‚Üí Configuration**: Ver configura√ß√£o do Prometheus

### Exemplos de Uso

#### Ver todos os metrics dispon√≠veis:
1. Acesse https://prometheus.home.arpa/
2. Clique em **Graph**
3. Clique no campo de query para ver sugest√µes

#### Executar query simples:
```promql
# Ver uso de CPU
node_cpu_seconds_total

# Ver mem√≥ria total
node_memory_MemTotal_bytes

# Ver pods por namespace
kube_pod_info
```

#### Ver targets sendo monitorados:
1. Clique em **Status ‚Üí Targets**
2. Voc√™ ver√° todos os exporters (node-exporter, kube-state-metrics, etc)

### Targets Monitorados

Automaticamente configurados:
- **node-exporter**: M√©tricas dos nodes (CPU, mem√≥ria, disco, rede)
- **kube-state-metrics**: M√©tricas do Kubernetes (pods, deployments, etc)
- **prometheus**: M√©tricas do pr√≥prio Prometheus
- **Services com annotations**: Qualquer service com `prometheus.io/scrape: "true"`

### Adicionar Novos Targets

Edite o ConfigMap:
```bash
kubectl edit configmap prometheus-config -n monitoring
```

Ou adicione annotations no seu service:
```yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8080"
    prometheus.io/path: "/metrics"
```

## üìù Loki - Logs Centralizados

### O que √© Loki

Loki √© um sistema de agrega√ß√£o de logs similar ao Prometheus, mas para logs. Ele permite consultar logs de todos os pods no cluster.

### Como Acessar Logs no Grafana

1. Acesse Grafana: https://grafana.home.arpa/
2. V√° em **Explore** (√≠cone de b√∫ssola no menu lateral)
3. Selecione **Loki** como Data Source
4. Use LogQL para consultar logs

### Exemplos de Queries LogQL

```logql
# Todos os logs do namespace monitoring
{namespace="monitoring"}

# Logs do pod Grafana
{namespace="monitoring", pod=~"grafana-.*"}

# Logs contendo "error"
{namespace="monitoring"} |= "error"

# Logs do Redis
{namespace="redis"}

# Logs com n√≠vel ERROR
{namespace="monitoring"} | json | level="ERROR"
```

### Instalar Promtail (Log Collector)

Se voc√™ quiser que Loki colete logs automaticamente de todos os pods:

```bash
# Criar ConfigMap do Promtail
kubectl apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: monitoring
data:
  promtail.yaml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push

    scrape_configs:
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: __host__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - action: replace
            replacement: \$1
            separator: /
            source_labels:
              - __meta_kubernetes_namespace
              - __meta_kubernetes_pod_name
            target_label: job
          - action: replace
            source_labels:
              - __meta_kubernetes_namespace
            target_label: namespace
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_name
            target_label: pod
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_container_name
            target_label: container
          - replacement: /var/log/pods/\$(__meta_kubernetes_pod_namespace)_\$(__meta_kubernetes_pod_name)_\$(__meta_kubernetes_pod_uid)/**/*.log
            separator: /
            source_labels:
              - __meta_kubernetes_pod_uid
              - __meta_kubernetes_pod_container_name
            target_label: __path__
EOF

# Criar DaemonSet do Promtail
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: promtail
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: promtail
  template:
    metadata:
      labels:
        app: promtail
    spec:
      serviceAccountName: promtail
      containers:
      - name: promtail
        image: grafana/promtail:2.9.0
        args:
          - -config.file=/etc/promtail/promtail.yaml
        volumeMounts:
        - name: config
          mountPath: /etc/promtail
        - name: varlog
          mountPath: /var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: promtail-config
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: promtail
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: promtail
rules:
  - apiGroups: [""]
    resources:
      - nodes
      - nodes/proxy
      - services
      - endpoints
      - pods
    verbs: ["get", "watch", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: promtail
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: promtail
subjects:
  - kind: ServiceAccount
    name: promtail
    namespace: monitoring
EOF
```

## üîî Configurar Alertas

### No Grafana

1. Crie ou edite um dashboard panel
2. Clique na aba **Alert**
3. Clique em **Create alert rule from this panel**
4. Configure condi√ß√µes (ex: CPU > 80%)
5. Configure notification channels (email, Slack, webhook)

### No Prometheus (AlertManager)

Edite o ConfigMap do Prometheus para adicionar regras:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: monitoring
data:
  alerts.yml: |
    groups:
    - name: example
      rules:
      - alert: HighCPUUsage
        expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 80% on {{ $labels.instance }}"

      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is above 80% on {{ $labels.instance }}"

      - alert: PodDown
        expr: kube_pod_status_phase{phase="Failed"} > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Pod is down"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is in Failed state"
```

## üîß Status dos Servi√ßos

### Verificar Pods
```bash
kubectl get pods -n monitoring
```

### Ver Logs
```bash
# Grafana
kubectl logs -n monitoring -l app=grafana -f

# Prometheus
kubectl logs -n monitoring prometheus-0 -f

# Loki
kubectl logs -n monitoring loki-0 -f
```

### Reiniciar Servi√ßos
```bash
# Grafana
kubectl rollout restart deployment/grafana -n monitoring

# Prometheus
kubectl rollout restart statefulset/prometheus -n monitoring

# Loki
kubectl rollout restart statefulset/loki -n monitoring
```

### Verificar PVCs
```bash
kubectl get pvc -n monitoring
```

### Acessar Console (troubleshooting)
```bash
# Grafana
kubectl exec -it -n monitoring deployment/grafana -- sh

# Prometheus
kubectl exec -it -n monitoring prometheus-0 -- sh

# Loki
kubectl exec -it -n monitoring loki-0 -- sh
```

## üö® Troubleshooting

### Grafana n√£o carrega dashboards
**Verificar**:
```bash
# Ver logs
kubectl logs -n monitoring -l app=grafana --tail=50

# Verificar se Prometheus √© acess√≠vel de dentro do pod
kubectl exec -n monitoring deployment/grafana -- wget -O- http://prometheus.monitoring.svc.cluster.local:9090/api/v1/status/config
```

### Prometheus n√£o est√° coletando m√©tricas
**Verificar targets**:
1. Acesse https://prometheus.home.arpa/targets
2. Veja se todos os targets est√£o "UP"

**Verificar RBAC**:
```bash
kubectl get clusterrolebinding prometheus
```

### Loki n√£o est√° recebendo logs
**Verificar se Promtail est√° instalado**:
```bash
kubectl get daemonset -n monitoring promtail
```

**Testar endpoint**:
```bash
kubectl exec -n monitoring prometheus-0 -- curl http://loki.monitoring.svc.cluster.local:3100/ready
```

### Grafana - senha n√£o funciona
**Resetar senha**:
```bash
# Atualizar secret
kubectl patch secret grafana-admin -n monitoring -p '{"stringData":{"GF_SECURITY_ADMIN_PASSWORD":"NovaSenh@123"}}'

# Reiniciar Grafana
kubectl rollout restart deployment/grafana -n monitoring
```

## üì± Acesso de Outros Dispositivos

### Mesmo Computador
‚úÖ Grafana: https://grafana.home.arpa/
‚úÖ Prometheus: https://prometheus.home.arpa/

### Outro Computador na Mesma Rede
‚úÖ Com DNS do roteador configurado, acesse diretamente os URLs acima

### Aplica√ß√µes no Kubernetes
```bash
# Prometheus (consultar m√©tricas)
http://prometheus.monitoring.svc.cluster.local:9090

# Loki (enviar logs)
http://loki.monitoring.svc.cluster.local:3100

# Grafana (embed dashboards)
http://grafana.monitoring.svc.cluster.local:3000
```

## üìö Refer√™ncias

- **Prometheus**: https://prometheus.io/docs/
- **Grafana**: https://grafana.com/docs/
- **Loki**: https://grafana.com/docs/loki/
- **PromQL**: https://prometheus.io/docs/prometheus/latest/querying/basics/
- **LogQL**: https://grafana.com/docs/loki/latest/logql/
- **Dashboards**: https://grafana.com/grafana/dashboards/

## üéâ Resumo

‚úÖ Monitoring Stack instalado com sucesso
‚úÖ Grafana: https://grafana.home.arpa/ (admin / Admin@123)
‚úÖ Prometheus: https://prometheus.home.arpa/
‚úÖ Loki: Interno (loki.monitoring.svc.cluster.local:3100)
‚úÖ TLS configurado com cert-manager
‚úÖ Persist√™ncia: Prometheus (20Gi), Grafana (10Gi), Loki (10Gi)
‚úÖ Node Exporter + Kube State Metrics configurados

**Monitore seu cluster com dashboards incr√≠veis!** üìä
