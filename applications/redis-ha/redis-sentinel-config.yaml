apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-config
  namespace: default
data:
  redis.conf: |
    # Configuração Redis Master
    port 6379
    bind 0.0.0.0
    protected-mode no
    
    # Persistência
    save 900 1
    save 300 10
    save 60 10000
    rdbcompression yes
    rdbchecksum yes
    dbfilename dump.rdb
    dir /data
    
    # Log
    loglevel notice
    logfile ""
    
    # Memory
    maxmemory 256mb
    maxmemory-policy allkeys-lru
    
    # Security
    rename-command FLUSHDB ""
    rename-command FLUSHALL ""
    
  sentinel.conf: |
    # Configuração Redis Sentinel
    port 26379
    bind 0.0.0.0
    protected-mode no
    
    # Monitorar o master
    sentinel monitor mymaster redis-master 6379 2
    sentinel down-after-milliseconds mymaster 5000
    sentinel parallel-syncs mymaster 1
    sentinel failover-timeout mymaster 10000
    
    # Log
    loglevel notice
    logfile ""

---
apiVersion: v1
kind: Service
metadata:
  name: redis-master
  namespace: default
  labels:
    app: redis
    role: master
spec:
  ports:
  - port: 6379
    targetPort: 6379
    name: redis
  selector:
    app: redis
    role: master
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  name: redis-slave
  namespace: default
  labels:
    app: redis
    role: slave
spec:
  ports:
  - port: 6379
    targetPort: 6379
    name: redis
  selector:
    app: redis
    role: slave
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  name: redis-sentinel
  namespace: default
  labels:
    app: redis
    role: sentinel
spec:
  ports:
  - port: 26379
    targetPort: 26379
    name: sentinel
  selector:
    app: redis
    role: sentinel
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  name: redis-ha
  namespace: default
  labels:
    app: redis
    role: ha
spec:
  ports:
  - port: 6379
    targetPort: 6379
    name: redis
  selector:
    app: redis
  type: ClusterIP