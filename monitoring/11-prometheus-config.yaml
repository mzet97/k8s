apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
    # ========== INFRASTRUCTURE ==========
    - job_name: 'prometheus'
      static_configs:
      - targets: ['localhost:9090']

    # Kubelet metrics (for node-level metrics)
    - job_name: 'kubelet'
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics
      metric_relabel_configs:
      - target_label: cluster
        replacement: homelab

    # cAdvisor metrics (for container-level metrics)
    - job_name: 'cadvisor'
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
      metric_relabel_configs:
      - target_label: cluster
        replacement: homelab

    - job_name: 'node-exporter'
      kubernetes_sd_configs:
      - role: endpoints
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace]
        action: keep
        regex: monitoring
      - source_labels: [__meta_kubernetes_service_name]
        action: keep
        regex: node-exporter
      - source_labels: [__meta_kubernetes_endpoint_port_name]
        action: keep
        regex: metrics

    - job_name: 'kube-state-metrics'
      kubernetes_sd_configs:
      - role: endpoints
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace]
        action: keep
        regex: monitoring
      - source_labels: [__meta_kubernetes_service_name]
        action: keep
        regex: kube-state-metrics
      metric_relabel_configs:
      - target_label: cluster
        replacement: homelab

    # ========== APPLICATIONS ==========

    # Kong Gateway - Status API metrics
    - job_name: 'kong'
      static_configs:
      - targets: ['kong-admin.kong.svc:8100']
      metrics_path: /metrics
      relabel_configs:
      - target_label: service
        replacement: kong

    # MinIO - Cluster metrics
    - job_name: 'minio'
      static_configs:
      - targets: ['minio-service.minio.svc:9000']
      metrics_path: /minio/v2/metrics/cluster
      relabel_configs:
      - target_label: service
        replacement: minio

    # MongoDB Exporter
    - job_name: 'mongodb-exporter'
      static_configs:
      - targets: ['mongodb-exporter.monitoring.svc:9216']
      relabel_configs:
      - target_label: service
        replacement: mongodb

    # N8N - Built-in metrics
    - job_name: 'n8n'
      static_configs:
      - targets: ['n8n.n8n.svc:5678']
      metrics_path: /metrics
      relabel_configs:
      - target_label: service
        replacement: n8n

    # NATS Exporter
    - job_name: 'nats-exporter'
      static_configs:
      - targets: ['nats-exporter.monitoring.svc:7777']
      relabel_configs:
      - target_label: service
        replacement: nats

    # RabbitMQ - Native prometheus endpoint
    - job_name: 'rabbitmq'
      static_configs:
      - targets: ['rabbitmq.rabbitmq.svc:15692']
      metrics_path: /metrics
      relabel_configs:
      - target_label: service
        replacement: rabbitmq

    # Redis Exporter
    - job_name: 'redis-exporter'
      static_configs:
      - targets: ['redis-exporter.monitoring.svc:9121']
      relabel_configs:
      - target_label: service
        replacement: redis

    # Loki metrics
    - job_name: 'loki'
      static_configs:
      - targets: ['loki.monitoring.svc:3100']
      metrics_path: /metrics
      relabel_configs:
      - target_label: service
        replacement: loki

    # Promtail metrics
    - job_name: 'promtail'
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace]
        action: keep
        regex: monitoring
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: keep
        regex: promtail
      - source_labels: [__meta_kubernetes_pod_container_port_name]
        action: keep
        regex: http-metrics
