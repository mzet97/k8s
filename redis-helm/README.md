# Redis com Helm (Bitnami)

Esta pasta cont√©m a configura√ß√£o para instalar Redis usando Helm Chart da Bitnami, mantendo a mesma arquitetura da instala√ß√£o manual: **1 Master + 3 Replicas com TLS e DNS**.

## üìã Vis√£o Geral

### Caracter√≠sticas
- **Arquitetura**: 1 Master + 3 Replicas
- **TLS**: Habilitado com certificados auto-gerados
- **DNS**: Configurado para resolu√ß√£o interna
- **Persist√™ncia**: Volumes persistentes para dados
- **Monitoramento**: Redis Exporter integrado
- **Autentica√ß√£o**: Senha configurada
- **Recursos**: Limits e requests definidos

### Vantagens do Helm
- ‚úÖ Instala√ß√£o simplificada
- ‚úÖ Gerenciamento de depend√™ncias
- ‚úÖ Atualiza√ß√µes facilitadas
- ‚úÖ Rollback autom√°tico
- ‚úÖ Configura√ß√£o centralizada
- ‚úÖ Suporte oficial Bitnami

## üöÄ Instala√ß√£o

### Pr√©-requisitos

1. **MicroK8s instalado e funcionando**:
   ```bash
   # Ubuntu/Linux
   sudo snap install microk8s --classic
   
   # Verificar status
   microk8s status
   ```

2. **Addons habilitados**:
   ```bash
   microk8s enable dns storage helm3 cert-manager
   ```

3. **Acesso ao cluster MicroK8s** configurado

> **‚ö†Ô∏è Nota sobre Seguran√ßa**: Este chart usa `global.security.allowInsecureImages=true` para contornar a nova verifica√ß√£o de seguran√ßa do Bitnami (dezembro 2024). Isso √© necess√°rio devido √† detec√ß√£o de imagens n√£o-padr√£o. <mcreference link="https://github.com/bitnami/charts/issues/30850" index="0">0</mcreference>

### Instala√ß√£o R√°pida

```bash
# Verificar se MicroK8s est√° rodando
microk8s status

# Entrar no diret√≥rio
cd redis-helm

# Executar instala√ß√£o
./install-redis-helm.sh
```

### Instala√ß√£o Manual

1. **Adicionar reposit√≥rio Bitnami**:
   ```bash
   microk8s helm3 repo add bitnami https://charts.bitnami.com/bitnami
   microk8s helm3 repo update
   ```

2. **Criar namespace**:
   ```bash
   microk8s kubectl create namespace redis
   ```

3. **Verificar cert-manager** (j√° habilitado):
   ```bash
   microk8s kubectl get pods -n cert-manager
   ```

4. **Instalar Redis**:
   ```bash
   microk8s helm3 install redis-cluster bitnami/redis \
     --namespace redis \
     --values values.yaml
   ```

## üìÅ Arquivos

| Arquivo | Descri√ß√£o |
|---------|----------|
| `Chart.yaml` | Defini√ß√£o do chart e depend√™ncias |
| `values.yaml` | Configura√ß√µes personalizadas do Redis |
| `install-redis-helm.sh` | Script de instala√ß√£o automatizada |
| `test-redis-helm.sh` | Script de testes de funcionalidade |
| `remove-redis-helm.sh` | Script de remo√ß√£o completa |
| `README.md` | Esta documenta√ß√£o |

## ‚öôÔ∏è Configura√ß√£o

### Principais Configura√ß√µes (values.yaml)

```yaml
# Arquitetura
architecture: replication

# Master
master:
  count: 1
  resources:
    requests:
      memory: 256Mi
      cpu: 250m
    limits:
      memory: 512Mi
      cpu: 500m

# Replicas
replica:
  replicaCount: 3
  resources:
    requests:
      memory: 256Mi
      cpu: 250m
    limits:
      memory: 512Mi
      cpu: 500m

# TLS
tls:
  enabled: true
  autoGenerated: true

# Autentica√ß√£o
auth:
  enabled: true
  password: "redis123"

# M√©tricas
metrics:
  enabled: true
```

### Personaliza√ß√£o

Para modificar a configura√ß√£o, edite o arquivo `values.yaml` e execute:

```bash
microk8s helm3 upgrade redis-cluster bitnami/redis \
  --namespace redis \
  --values values.yaml
```

### Configura√ß√£o de Seguran√ßa

O chart inclui configura√ß√£o especial para contornar a nova verifica√ß√£o de seguran√ßa do Bitnami:

```yaml
global:
  security:
    allowInsecureImages: true
```

Esta configura√ß√£o √© necess√°ria devido √†s mudan√ßas de seguran√ßa implementadas em dezembro de 2024.

## üß™ Testes

### Teste Completo
```bash
./test-redis-helm.sh
```

### Testes Manuais

1. **Verificar pods**:
   ```bash
   microk8s kubectl get pods -n redis
   ```

2. **Obter senha**:
   ```bash
   microk8s kubectl get secret redis-cluster -n redis -o jsonpath='{.data.redis-password}' | base64 -d
   ```

3. **Conectar ao Master**:
   ```bash
   microk8s kubectl run redis-client --rm -it --restart=Never \
     --namespace redis \
     --image docker.io/bitnami/redis:7.2.4-debian-11-r0 -- bash
   
   # Dentro do pod:
   REDISCLI_AUTH=$(microk8s kubectl get secret redis-cluster -n redis -o jsonpath='{.data.redis-password}' | base64 -d)
   redis-cli -h redis-cluster-master.redis.svc.cluster.local -p 6379 --tls --insecure
   ```

4. **Conectar √†s Replicas**:
   ```bash
   redis-cli -h redis-cluster-replica.redis.svc.cluster.local -p 6379 --tls --insecure
   ```

## üìä Monitoramento

### M√©tricas Redis
```bash
# Port-forward para m√©tricas
microk8s kubectl port-forward svc/redis-cluster-metrics 9121:9121 -n redis

# Acessar m√©tricas
curl http://localhost:9121/metrics
```

### Logs
```bash
# Logs do Master
microk8s kubectl logs -f redis-cluster-master-0 -n redis

# Logs das Replicas
microk8s kubectl logs -f redis-cluster-replica-0 -n redis
microk8s kubectl logs -f redis-cluster-replica-1 -n redis
microk8s kubectl logs -f redis-cluster-replica-2 -n redis
```

## üîß Gerenciamento

### Comandos √öteis

```bash
# Listar releases
microk8s helm3 list -n redis

# Status do release
microk8s helm3 status redis-cluster -n redis

# Hist√≥rico de releases
microk8s helm3 history redis-cluster -n redis

# Rollback
microk8s helm3 rollback redis-cluster 1 -n redis

# Upgrade
microk8s helm3 upgrade redis-cluster bitnami/redis --namespace redis --values values.yaml

# Desinstalar
microk8s helm3 uninstall redis-cluster -n redis
```

### Backup e Restore

```bash
# Backup manual
microk8s kubectl exec redis-cluster-master-0 -n redis -- redis-cli --rdb /tmp/backup.rdb

# Copiar backup
microk8s kubectl cp redis-cluster-master-0:/tmp/backup.rdb ./backup.rdb -n redis
```

## üóëÔ∏è Remo√ß√£o

### Remo√ß√£o Completa
```bash
./remove-redis-helm.sh
```

### Remo√ß√£o Manual
```bash
# Remover release
microk8s helm3 uninstall redis-cluster -n redis

# Remover PVCs (dados)
microk8s kubectl delete pvc --all -n redis

# Remover namespace
microk8s kubectl delete namespace redis
```

## üîç Troubleshooting

### Problemas Comuns

1. **Pods n√£o iniciam**:
   ```bash
   microk8s kubectl describe pod redis-cluster-master-0 -n redis
   microk8s kubectl logs redis-cluster-master-0 -n redis
   ```

2. **Erro de TLS**:
   ```bash
   microk8s kubectl get certificates -n redis
   microk8s kubectl describe certificate redis-tls-cert -n redis
   ```

3. **Problemas de conectividade**:
   ```bash
   microk8s kubectl get svc -n redis
   microk8s kubectl get endpoints -n redis
   ```

4. **Verificar configura√ß√£o**:
   ```bash
   microk8s helm3 get values redis-cluster -n redis
   microk8s kubectl get configmap -n redis -o yaml
   ```

5. **MicroK8s n√£o responde**:
   ```bash
   microk8s status
   microk8s start
   microk8s reset  # √∫ltimo recurso
   ```

6. **Erro de verifica√ß√£o de seguran√ßa Bitnami**:
   ```bash
   # Se aparecer erro sobre "Original containers have been substituted"
   # O chart j√° est√° configurado com allowInsecureImages=true
   # Verifique se o values.yaml cont√©m:
   global:
     security:
       allowInsecureImages: true
   ```

### Logs de Debug

```bash
# Habilitar debug no Helm
microk8s helm3 install redis-cluster bitnami/redis \
  --namespace redis \
  --values values.yaml \
  --debug --dry-run
```

## üìö Refer√™ncias

- [Bitnami Redis Helm Chart](https://artifacthub.io/packages/helm/bitnami/redis) <mcreference link="https://artifacthub.io/packages/helm/bitnami/redis" index="0">0</mcreference>
- [Deploying Redis on Kubernetes with Helm Guide](https://medium.com/@hamzanasir323/deploying-redis-on-kubernetes-with-helm-a-step-by-step-guide-2-c79e27035ef6) <mcreference link="https://medium.com/@hamzanasir323/deploying-redis-on-kubernetes-with-helm-a-step-by-step-guide-2-c79e27035ef6" index="1">1</mcreference>
- [Helm Documentation](https://helm.sh/docs/)
- [Redis Documentation](https://redis.io/documentation)

## üÜö Compara√ß√£o: Helm vs Manual

| Aspecto | Helm + MicroK8s | Manual |
|---------|------------------|--------|
| **Instala√ß√£o** | Simples (1 comando) | Complexa (m√∫ltiplos YAMLs) |
| **Manuten√ß√£o** | Facilitada | Manual |
| **Atualiza√ß√µes** | Autom√°tica | Manual |
| **Rollback** | Nativo | Manual |
| **Configura√ß√£o** | Centralizada | Distribu√≠da |
| **Depend√™ncias** | Gerenciadas | Manuais |
| **Documenta√ß√£o** | Oficial | Customizada |
| **Ambiente** | MicroK8s otimizado | Qualquer K8s |
| **Flexibilidade** | Limitada | Total |
| **Controle** | Abstrato | Direto |

## üéØ Pr√≥ximos Passos

1. **Integra√ß√£o com Prometheus**: Configurar ServiceMonitor
2. **Backup Automatizado**: Implementar CronJob de backup
3. **Alta Disponibilidade**: Configurar anti-affinity
4. **Seguran√ßa**: Implementar NetworkPolicies
5. **Scaling**: Configurar HPA para replicas

---

**Nota**: Esta configura√ß√£o mant√©m a mesma funcionalidade da instala√ß√£o manual, mas com a simplicidade e robustez do Helm.