# Redis com Helm (Bitnami)

Esta pasta contém a configuração para instalar Redis usando Helm Chart da Bitnami, mantendo a mesma arquitetura da instalação manual: **1 Master + 3 Replicas com TLS e DNS**.

## 📋 Visão Geral

### Características
- **Arquitetura**: 1 Master + 3 Replicas
- **TLS**: Habilitado com certificados auto-gerados
- **DNS**: Configurado para resolução interna
- **Persistência**: Volumes persistentes para dados
- **Monitoramento**: Redis Exporter integrado
- **Autenticação**: Senha configurada
- **Recursos**: Limits e requests definidos

### Vantagens do Helm
- ✅ Instalação simplificada
- ✅ Gerenciamento de dependências
- ✅ Atualizações facilitadas
- ✅ Rollback automático
- ✅ Configuração centralizada
- ✅ Suporte oficial Bitnami

## 🚀 Instalação

### Pré-requisitos

1. **MicroK8s instalado e funcionando**:
   ```bash
   # Ubuntu/Linux
   sudo snap install microk8s --classic
   
   # Verificar status
   microk8s status
   ```

2. **Addons habilitados**:
   ```bash
   microk8s enable dns storage helm3 cert-manager
   ```

3. **Acesso ao cluster MicroK8s** configurado

### Instalação Rápida

```bash
# Verificar se MicroK8s está rodando
microk8s status

# Entrar no diretório
cd redis-helm

# Executar instalação
./install-redis-helm.sh
```

### Instalação Manual

1. **Adicionar repositório Bitnami**:
   ```bash
   microk8s helm3 repo add bitnami https://charts.bitnami.com/bitnami
   microk8s helm3 repo update
   ```

2. **Criar namespace**:
   ```bash
   microk8s kubectl create namespace redis
   ```

3. **Verificar cert-manager** (já habilitado):
   ```bash
   microk8s kubectl get pods -n cert-manager
   ```

4. **Instalar Redis**:
   ```bash
   microk8s helm3 install redis-cluster bitnami/redis \
     --namespace redis \
     --values values.yaml
   ```

## 📁 Arquivos

| Arquivo | Descrição |
|---------|----------|
| `Chart.yaml` | Definição do chart e dependências |
| `values.yaml` | Configurações personalizadas do Redis |
| `install-redis-helm.sh` | Script de instalação automatizada |
| `test-redis-helm.sh` | Script de testes de funcionalidade |
| `remove-redis-helm.sh` | Script de remoção completa |
| `README.md` | Esta documentação |

## ⚙️ Configuração

### Principais Configurações (values.yaml)

```yaml
# Arquitetura
architecture: replication

# Master
master:
  count: 1
  resources:
    requests:
      memory: 256Mi
      cpu: 250m
    limits:
      memory: 512Mi
      cpu: 500m

# Replicas
replica:
  replicaCount: 3
  resources:
    requests:
      memory: 256Mi
      cpu: 250m
    limits:
      memory: 512Mi
      cpu: 500m

# TLS
tls:
  enabled: true
  autoGenerated: true

# Autenticação
auth:
  enabled: true
  password: "redis123"

# Métricas
metrics:
  enabled: true
```

### Personalização

Para modificar a configuração, edite o arquivo `values.yaml` e execute:

```bash
microk8s helm3 upgrade redis-cluster bitnami/redis \
  --namespace redis \
  --values values.yaml
```

## 🧪 Testes

### Teste Completo
```bash
./test-redis-helm.sh
```

### Testes Manuais

1. **Verificar pods**:
   ```bash
   microk8s kubectl get pods -n redis
   ```

2. **Obter senha**:
   ```bash
   microk8s kubectl get secret redis-cluster -n redis -o jsonpath='{.data.redis-password}' | base64 -d
   ```

3. **Conectar ao Master**:
   ```bash
   microk8s kubectl run redis-client --rm -it --restart=Never \
     --namespace redis \
     --image docker.io/bitnami/redis:7.2.4-debian-11-r0 -- bash
   
   # Dentro do pod:
   REDISCLI_AUTH=$(microk8s kubectl get secret redis-cluster -n redis -o jsonpath='{.data.redis-password}' | base64 -d)
   redis-cli -h redis-cluster-master.redis.svc.cluster.local -p 6379 --tls --insecure
   ```

4. **Conectar às Replicas**:
   ```bash
   redis-cli -h redis-cluster-replica.redis.svc.cluster.local -p 6379 --tls --insecure
   ```

## 📊 Monitoramento

### Métricas Redis
```bash
# Port-forward para métricas
microk8s kubectl port-forward svc/redis-cluster-metrics 9121:9121 -n redis

# Acessar métricas
curl http://localhost:9121/metrics
```

### Logs
```bash
# Logs do Master
microk8s kubectl logs -f redis-cluster-master-0 -n redis

# Logs das Replicas
microk8s kubectl logs -f redis-cluster-replica-0 -n redis
microk8s kubectl logs -f redis-cluster-replica-1 -n redis
microk8s kubectl logs -f redis-cluster-replica-2 -n redis
```

## 🔧 Gerenciamento

### Comandos Úteis

```bash
# Listar releases
microk8s helm3 list -n redis

# Status do release
microk8s helm3 status redis-cluster -n redis

# Histórico de releases
microk8s helm3 history redis-cluster -n redis

# Rollback
microk8s helm3 rollback redis-cluster 1 -n redis

# Upgrade
microk8s helm3 upgrade redis-cluster bitnami/redis --namespace redis --values values.yaml

# Desinstalar
microk8s helm3 uninstall redis-cluster -n redis
```

### Backup e Restore

```bash
# Backup manual
microk8s kubectl exec redis-cluster-master-0 -n redis -- redis-cli --rdb /tmp/backup.rdb

# Copiar backup
microk8s kubectl cp redis-cluster-master-0:/tmp/backup.rdb ./backup.rdb -n redis
```

## 🗑️ Remoção

### Remoção Completa
```bash
./remove-redis-helm.sh
```

### Remoção Manual
```bash
# Remover release
microk8s helm3 uninstall redis-cluster -n redis

# Remover PVCs (dados)
microk8s kubectl delete pvc --all -n redis

# Remover namespace
microk8s kubectl delete namespace redis
```

## 🔍 Troubleshooting

### Problemas Comuns

1. **Pods não iniciam**:
   ```bash
   microk8s kubectl describe pod redis-cluster-master-0 -n redis
   microk8s kubectl logs redis-cluster-master-0 -n redis
   ```

2. **Erro de TLS**:
   ```bash
   microk8s kubectl get certificates -n redis
   microk8s kubectl describe certificate redis-tls-cert -n redis
   ```

3. **Problemas de conectividade**:
   ```bash
   microk8s kubectl get svc -n redis
   microk8s kubectl get endpoints -n redis
   ```

4. **Verificar configuração**:
   ```bash
   microk8s helm3 get values redis-cluster -n redis
   microk8s kubectl get configmap -n redis -o yaml
   ```

5. **MicroK8s não responde**:
   ```bash
   microk8s status
   microk8s start
   microk8s reset  # último recurso
   ```

### Logs de Debug

```bash
# Habilitar debug no Helm
microk8s helm3 install redis-cluster bitnami/redis \
  --namespace redis \
  --values values.yaml \
  --debug --dry-run
```

## 📚 Referências

- [Bitnami Redis Helm Chart](https://artifacthub.io/packages/helm/bitnami/redis) <mcreference link="https://artifacthub.io/packages/helm/bitnami/redis" index="0">0</mcreference>
- [Deploying Redis on Kubernetes with Helm Guide](https://medium.com/@hamzanasir323/deploying-redis-on-kubernetes-with-helm-a-step-by-step-guide-2-c79e27035ef6) <mcreference link="https://medium.com/@hamzanasir323/deploying-redis-on-kubernetes-with-helm-a-step-by-step-guide-2-c79e27035ef6" index="1">1</mcreference>
- [Helm Documentation](https://helm.sh/docs/)
- [Redis Documentation](https://redis.io/documentation)

## 🆚 Comparação: Helm vs Manual

| Aspecto | Helm + MicroK8s | Manual |
|---------|------------------|--------|
| **Instalação** | Simples (1 comando) | Complexa (múltiplos YAMLs) |
| **Manutenção** | Facilitada | Manual |
| **Atualizações** | Automática | Manual |
| **Rollback** | Nativo | Manual |
| **Configuração** | Centralizada | Distribuída |
| **Dependências** | Gerenciadas | Manuais |
| **Documentação** | Oficial | Customizada |
| **Ambiente** | MicroK8s otimizado | Qualquer K8s |
| **Flexibilidade** | Limitada | Total |
| **Controle** | Abstrato | Direto |

## 🎯 Próximos Passos

1. **Integração com Prometheus**: Configurar ServiceMonitor
2. **Backup Automatizado**: Implementar CronJob de backup
3. **Alta Disponibilidade**: Configurar anti-affinity
4. **Segurança**: Implementar NetworkPolicies
5. **Scaling**: Configurar HPA para replicas

---

**Nota**: Esta configuração mantém a mesma funcionalidade da instalação manual, mas com a simplicidade e robustez do Helm.