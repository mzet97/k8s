apiVersion: batch/v1
kind: Job
metadata:
  name: redis-cluster-bootstrap
  namespace: redis
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: bootstrap
        image: redis:7-alpine
        imagePullPolicy: IfNotPresent
        env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-auth
              key: REDIS_PASSWORD
        command:
        - sh
        - -lc
        args:
        - |
          set -e
          echo "Aguardando pods ficarem prontos (DNS e porta 6379)..."
          hosts="\
            redis-cluster-0.redis-cluster-headless.redis.svc.cluster.local \
            redis-cluster-1.redis-cluster-headless.redis.svc.cluster.local \
            redis-cluster-2.redis-cluster-headless.redis.svc.cluster.local"
          # Espera DNS
          for i in $(seq 1 60); do
            ready=0
            for h in $hosts; do
              getent hosts "$h" >/dev/null 2>&1 && ready=$((ready+1))
            done
            [ "$ready" -eq 3 ] && break
            sleep 3
          done
          # Espera TCP:6379
          for h in $hosts; do
            for i in $(seq 1 60); do
              (echo PING | nc -w2 "$h" 6379 >/dev/null 2>&1) && break
              sleep 2
            done
          done
          echo "Criando cluster (3 mestres, sem r√©plicas)..."
          yes yes | redis-cli --cluster create \
            redis-cluster-0.redis-cluster-headless.redis.svc.cluster.local:6379 \
            redis-cluster-1.redis-cluster-headless.redis.svc.cluster.local:6379 \
            redis-cluster-2.redis-cluster-headless.redis.svc.cluster.local:6379 \
            --cluster-replicas 0 -a "$REDIS_PASSWORD"
          echo "OK - Cluster criado."